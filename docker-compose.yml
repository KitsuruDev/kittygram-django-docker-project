services:
  web:
    build: .
    volumes:
      - static_volume:/app/collected_static
      - media_volume:/app/media
    expose:
      - "8000"
    environment:
      - DEBUG=False
      - SECRET_KEY=django-insecure-3+t+lbqf@d7qy#g9h9g*aexo*s!ddg@*9-(%hb8&nfiu4j#knd
      - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,web,nginx
      - DATABASE_URL=sqlite:///db.sqlite3
      - DJANGO_SETTINGS_MODULE=kittygram.settings
    working_dir: /app/kittygram
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput --clear &&
             /app/copy_frontend.sh &&
             gunicorn kittygram.wsgi:application --bind 0.0.0.0:8000 --workers 3 --limit-request-line 8190 --timeout 120"

  nginx:
    image: nginx:1.21-alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - static_volume:/app/collected_static
      - media_volume:/app/media
    depends_on:
      - web

volumes:
  media_volume:
  static_volume: